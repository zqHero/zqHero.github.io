<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clean架构开发Android指南 # | 三少爷的剑</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.e1f02745.css" as="style"><link rel="preload" href="/assets/js/app.ea900448.js" as="script"><link rel="preload" href="/assets/js/2.1721b7ec.js" as="script"><link rel="preload" href="/assets/js/3.161a97f9.js" as="script"><link rel="preload" href="/assets/js/24.e1a2b1ca.js" as="script"><link rel="preload" href="/assets/js/7.06ceafdc.js" as="script"><link rel="prefetch" href="/assets/js/10.d6c05d0e.js"><link rel="prefetch" href="/assets/js/11.3e0dc188.js"><link rel="prefetch" href="/assets/js/12.2bdce60a.js"><link rel="prefetch" href="/assets/js/13.ba277a70.js"><link rel="prefetch" href="/assets/js/14.54af1e90.js"><link rel="prefetch" href="/assets/js/15.47fd7982.js"><link rel="prefetch" href="/assets/js/16.c6aa6ea8.js"><link rel="prefetch" href="/assets/js/17.d1b86438.js"><link rel="prefetch" href="/assets/js/18.6eeae5ff.js"><link rel="prefetch" href="/assets/js/19.398db2fb.js"><link rel="prefetch" href="/assets/js/20.9e308835.js"><link rel="prefetch" href="/assets/js/21.cda31fb6.js"><link rel="prefetch" href="/assets/js/22.422ffe3e.js"><link rel="prefetch" href="/assets/js/23.10a6a59e.js"><link rel="prefetch" href="/assets/js/25.4430aa20.js"><link rel="prefetch" href="/assets/js/26.aecdc2bf.js"><link rel="prefetch" href="/assets/js/27.5ab7a20f.js"><link rel="prefetch" href="/assets/js/28.b6c12d4a.js"><link rel="prefetch" href="/assets/js/29.9e4a244d.js"><link rel="prefetch" href="/assets/js/30.9e7d3581.js"><link rel="prefetch" href="/assets/js/31.5bc51c31.js"><link rel="prefetch" href="/assets/js/32.af91a39a.js"><link rel="prefetch" href="/assets/js/33.e37068d9.js"><link rel="prefetch" href="/assets/js/34.fd5a362f.js"><link rel="prefetch" href="/assets/js/35.9a826cee.js"><link rel="prefetch" href="/assets/js/36.ad6f2973.js"><link rel="prefetch" href="/assets/js/37.37f1d88d.js"><link rel="prefetch" href="/assets/js/38.9c91ca5b.js"><link rel="prefetch" href="/assets/js/39.6f87e092.js"><link rel="prefetch" href="/assets/js/4.b251fa0c.js"><link rel="prefetch" href="/assets/js/40.de110f98.js"><link rel="prefetch" href="/assets/js/41.5db20c65.js"><link rel="prefetch" href="/assets/js/5.52083e85.js"><link rel="prefetch" href="/assets/js/6.e3c7f1e9.js"><link rel="prefetch" href="/assets/js/8.a339b318.js"><link rel="prefetch" href="/assets/js/9.da927fdd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e1f02745.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar m_nav"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">zqHero</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/android/A001.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">城南旧事</a></div><div class="nav-item"><a href="/thought/read_note/R001.html" class="nav-link">归去来兮</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/AboutMe.html" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/about/DownLoad.html" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/about/blog_note/BuildNote1.html" class="nav-link">手记</a></li></ul></div></div><div class="nav-item"><a href="https://blog.csdn.net/u013233097" target="_blank" rel="noopener noreferrer" class="nav-link external">
  csdn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zqHero" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/android/A001.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">城南旧事</a></div><div class="nav-item"><a href="/thought/read_note/R001.html" class="nav-link">归去来兮</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/AboutMe.html" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/about/DownLoad.html" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/about/blog_note/BuildNote1.html" class="nav-link">手记</a></li></ul></div></div><div class="nav-item"><a href="https://blog.csdn.net/u013233097" target="_blank" rel="noopener noreferrer" class="nav-link external">
  csdn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zqHero" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>Android</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/articles/android/A001.html" aria-current="page" class="active sidebar-link">#Clean架构开发Android指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/android/A001.html#_01-前言" class="sidebar-link">&amp;01.前言</a></li><li class="sidebar-sub-header"><a href="/articles/android/A001.html#_02-clean是什么" class="sidebar-link">&amp;02.Clean是什么？</a></li><li class="sidebar-sub-header"><a href="/articles/android/A001.html#_03-该架构可使项目有如下特性" class="sidebar-link">&amp;03.该架构可使项目有如下特性</a></li><li class="sidebar-sub-header"><a href="/articles/android/A001.html#_04-android中如何表现" class="sidebar-link">&amp;04.Android中如何表现</a></li><li class="sidebar-sub-header"><a href="/articles/android/A001.html#_05-如何使用clean架构" class="sidebar-link">&amp;05.如何使用Clean架构？</a></li></ul></li><li><a href="/articles/android/A002.html" class="sidebar-link">#Android图片高斯模糊和镜像翻转</a></li><li><a href="/articles/android/A003.html" class="sidebar-link">#MVP模式浅析</a></li><li><a href="/articles/android/A004.html" class="sidebar-link">#Flutter导航拦截:WillPopScope</a></li><li><a href="/articles/android/A005.html" class="sidebar-link">#混合之Activity引用ReactNative</a></li></ul></section></li><li><section class="sidebar-group collapsable"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/articles/" aria-current="page" class="sidebar-link">Time-Line</a></li></ul> </aside> <main class="page"> <div class="content__default"><h1 id="clean架构开发android指南"><a href="#clean架构开发android指南" class="header-anchor">#</a> Clean架构开发Android指南</h1> <h2 id="_01-前言"><a href="#_01-前言" class="header-anchor">#</a> &amp;01.前言</h2> <p>自从开始开发安卓应用，我一直感觉我可以做得更好。我看过不少烂代码，其中当然有我写的。安卓系统的复杂性加上烂代码势必酿成灾祸，所以从错误中成长就很重要。我Google了如何更好地开发应用，发现了这个叫做 Clean 架构的东西。于是我尝试将它应用于安卓开发，根据我在类似项目中的经验做了一些改善，写出了这篇我觉得较为实用、值得分享的文章。我会在这篇文章中手把手教你在Android应用中使用Clean架构。我最近一直用这种方式优雅地编写应用。</p> <h2 id="_02-clean是什么"><a href="#_02-clean是什么" class="header-anchor">#</a> &amp;02.Clean是什么？</h2> <p>有许多文章已经很好地回答了这个问题。我在这里讲一讲Clean架构的核心概念。
一般来说，在Clean架构中，代码被分层成洋葱形，层层包裹，其中有一个依赖性规则：内层不能依赖外层，即内层不知道有关外层的任何事情，所以这个架构是向内依赖的。看个图感受一下：</p> <p><img src="/assets/img/001.c051d2cf.png" alt="clean"></p> <h2 id="_03-该架构可使项目有如下特性"><a href="#_03-该架构可使项目有如下特性" class="header-anchor">#</a> &amp;03.该架构可使项目有如下特性</h2> <p>-独立于架构</p> <p>-易于测试</p> <p>-独立于UI</p> <p>-独立于数据库</p> <p>-独立于任何外部类库</p> <h2 id="_04-android中如何表现"><a href="#_04-android中如何表现" class="header-anchor">#</a> &amp;04.Android中如何表现</h2> <p>-一般来说，一个应用可以有任意数目的层，但除非你的应用到处是企业级功能逻辑，一般需要这三层：</p> <p>-外层：实现层:
接口实现层是体现架构细节的地方。实现架构的代码是所有不用来解决问题的代码，这包括所有与安卓相关的东西，比如创建Activity和Fragment，发送Intent以及其他联网与数据库的架构相关的代码。</p> <p>-中层：接口适配层:
添加接口适配层的目的就是桥接逻辑层和架构层的代码。</p> <p>-内层：逻辑层
这里包含了真正解决问题的代码。这一层不包含任何实现架构的代码， 不用模拟器也应能运行这里的代码 。这样一来你的逻辑代码就有了易于测试、开发和维护的优点。这就是Clean架构的一个主要的好处。</p> <p>每一个位于核心层外部的层都应能将外部模型转成可以被内层处理的内部模型。内层不能持有属于外层的模型类的引用。这也是由于刚才说的依赖性规则，这样内外层可以很好地分离。
为什么要进行模型转换呢？举个例子，当逻辑层的模型不能直接很优雅地展现给用户，或是需要同时展示多个逻辑层的模型时，最好创建一个ViewModel类来更好的进行UI展示。这样一来，你就需要一个属于外层的Converter类来将逻辑层模型转换成合适的ViewModel。
再举一个例子：你从外部数据库层获得了ContentProvider的Cursor对象，外层首先要将这个对象转换成内层模型，再将它传给内层处理。
在文章的最后我还提供了一些学习资源。我们已经知道了Clean架构的基本原则，现在我们来实践一下。我会在下一部分中使用Clean架构构建一个示例功能。</p> <h2 id="_05-如何使用clean架构"><a href="#_05-如何使用clean架构" class="header-anchor">#</a> &amp;05.如何使用Clean架构？</h2> <p>我已经写好了一个样板项目，里面把准备工作做好了。这相当于是一个Clean的底层包，可以直接在它的基础上进行开发。请随意下载、修改。</p> <p>项目包: <a href="https://github.com/dmilicic/Android-Clean-Boilerplate" target="_blank" rel="noopener noreferrer">Android Clean Boilerplate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>开始写用例:</p> <p>这一部分会详细说明如何用在样例项目的基础之上以Clean方式进行开发。
首先让我们看一下应用的结构，当这只是我的习惯，不需要完全按这个进行。</p> <p>-一般来说一个安卓应用的结构如下：</p> <p>-外层项目包：UI，Storage，Network等等。</p> <p>-中层项目包：Presenter，Converter。</p> <p>-内层项目包：Interactor，Model，Repository，Executor。</p> <p>看不懂不要紧，下面有具体解释:
UI– 包括所有的Activity，Fragment，Adapter和其他UI相关的Android代码。</p> <p>Storage– 用于让交互类获取和存储数据的接口实现类，包含了数据库相关的代码。包括了如ContentProvider或DBFlow等组件。</p> <p>Network– 网络操作。</p> <p>桥接实现代码与逻辑代码的Glue Code。</p> <p>Presenter– presenter处理UI事件，如单击事件，通常包含内层Interactor的回调方法。</p> <p>Converter– 负责将内外层的模型互相转换。</p> <p>内层包含了最高级的代码，里面都是POJO类，这一层的类和对象不知道外层的任何信息，且应能在任何JVM下运行。</p> <p>Interactor– Interactor中包含了解决问题的逻辑代码。这里的代码在后台执行，并通过回调方法向外层传递事件。在其他项目中这个模块被称为用例Use Case。一个项目中可能有很多小Interactor，这符合单一职责原则，而且这样更容易让人接受。</p> <p>Model– 在业务逻辑代码中操作的业务模型。</p> <p>Repository– 包含接口让外层类实现，如操作数据库的类等。Interactor用这些接口的实现类来读取和存储数据。这也叫资源库模式Repository Pattern。</p> <p>Executor– 通过Worker Thread Executor让Interactor在后台执行。一般不需要修改这个包里的代码。</p> <p>以下是例子</p> <p>-在这个简单例子中，我们的use case是 在应用启动时读取数据库中的欢迎语句并展示 。下面演示如何编写代码包让use case运行起来。</p> <p>-presentation包</p> <p>-storage包</p> <p>-domain包</p> <p>前两个包属于外层，最后一个包属于内层（核心层）。presentation包负责将信息展示在屏幕上，而且包含整个MVP栈，即同时包含UI和presenter这两个属于不同层的组件。下面上码。
写一个内层的Interactor。你可以从任何一层开始编写，我建议从内层的逻辑代码写起。因为逻辑代码写好之后可以测试，不需要activity也可以正常运行。</p> <p>所以我们先写一个Interactor，这个Interactor包含了处理业务逻辑的代码。所有的Interactor都应该在后台运行，而不应影响UI展示。
我在这里先编写一个WelcomingInteractor。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WelcomingInteractor</span> <span class="token keyword">extends</span> <span class="token class-name">Interactor</span> <span class="token punctuation">{</span> 
      <span class="token keyword">interface</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span> 
          <span class="token keyword">void</span> <span class="token function">onMessageRetrieved</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">void</span> <span class="token function">onRetrievalFailed</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Callback负责与主线程的UI组件联通。将它放在WelcomingInteractor中可以避免给所有Callback接口起不同的名字而又能将它们有效区分。而后我们要实现获取消息的逻辑。现在已经有一个接口MessageRepository用于获取数据：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageRepository</span> <span class="token punctuation">{</span> 
    <span class="token class-name">String</span> <span class="token function">getWelcomeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们可以用业务逻辑代码来实现Interactor接口了。注意要实现AbstractInteractor接口，这样代码就会在后台执行了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WelcomingInteractorImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractInteractor</span> <span class="token keyword">implements</span> <span class="token class-name">WelcomingInteractor</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMainThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mCallback<span class="token punctuation">.</span><span class="token function">onRetrievalFailed</span><span class="token punctuation">(</span><span class="token string">&quot;Nothing to welcome you with :(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMainThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mCallback<span class="token punctuation">.</span><span class="token function">onMessageRetrieved</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>               

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 获取消息</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> message <span class="token operator">=</span> mMessageRepository<span class="token punctuation">.</span><span class="token function">getWelcomeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token comment">// 检查是否获取失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> message<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 在主线程中通知错误</span>
            <span class="token function">notifyError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 已成功获取消息，通知UI</span>
        <span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这段代码获取了数据，并向UI层发送数据或报错。这里通过Callback向UI发送信息，这个Callback扮演的是presenter的角色。这段代码是逻辑的核心，其他代码都是依赖框架的。看一下这个类的引用：</p> <p>可以看到，没有和Android相关的类库，这就是Clean架构的好处。还有就是写逻辑代码时不需要关心UI或数据库，只需要调用外层实现的Callback的回调方法。
测试Interactor</p> <p>现在不需要模拟器也可以运行这段代码了，我们编写一个JUnit测试来确保这段代码运行正常。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  @Test
  public void testWelcomeMessageFound() throws Exception {
      String msg = &quot;Welcome, friend!&quot;;
      when(mMessageRepository.getWelcomeMessage()).thenReturn(msg);
      WelcomingInteractorImpl interactor = new WelcomingInteractorImpl(
          mExecutor,
          mMainThread,
          mMockedCallback,
          mMessageRepository
          );
      interactor.run();
      Mockito.verify(mMessageRepository).getWelcomeMessage();
      Mockito.verifyNoMoreInteractions(mMessageRepository);
      Mockito.verify(mMockedCallback).onMessageRetrieved(msg);
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>重复一遍，Interactor根本不知道它在Android环境下运行。
编写presentation层</p> <p>Presentation层在Clean架构中属于外层的范围，它依赖于框架，包含了UI展示的代码。我们用MainActivity类在应用启动时展示欢迎信息。</p> <p>首先编写Presenter和View的接口。View只需要展示欢迎信息。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MainPresenter</span> <span class="token keyword">extends</span> <span class="token class-name">BasePresenter</span> <span class="token punctuation">{</span>
    <span class="token keyword">interface</span> <span class="token class-name">View</span> <span class="token keyword">extends</span> <span class="token class-name">BaseView</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">displayWelcomeMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>那怎么在App启动时运行Interactor呢？所有和View无关的代码都写进Presenter类中。这样可以实现关注分离(Separation of Concerns)并能避免Activity过于复杂。这些代码包括和Interactor交互的代码。</p> <p>在MainActivity中重写onResume()方法。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Override
protected void onResume() {
    super.onResume();

    // 在活动resume时开始获取数据
    mPresenter.resume();
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>所有的Presenter在继承BasePresenter时都要实现resume()方法。我们在MainPresenter的onResume()方法中启动Interactor。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  public void resume() {
      mView.showProgress();
      // 初始化Interactor
      WelcomingInteractor interactor = new WelcomingInteractorImpl(
              mExecutor,
              mMainThread,
              this,
              mMessageRepository
      );
      // 执行interactor
      interactor.execute();
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>execute()方法会在后台线程中调用WelcomingInteractorImpl类的run()方法。run()方法的实现可以看上文 写一个内层的Interactor 部分。</p> <p>你可能已经发现Interactor很像AsyncTask，都是提供所有需要的东西然后运行。那为什么不用AsyncTask呢？因为AsyncTask是Android的代码，需要模拟器来运行与测试。</p> <p>在上面的代码中我们给Interactor传入了下列属性：</p> <p>ThreadExecutor对象：用于在后台线程运行Interactor。我喜欢将这个类设计成单例。这个类属于domain包，不需要在外层实现。</p> <p>MainThreadImpl对象：用于在主线程中执行Interactor的Runnable对象。在依赖框架的外层代码中我们可以访问主线程，所以这个类要在外层实现。</p> <p>我们传入this是因为MainPresenter也是一个Callback对象，Interactor要通过Callback来更新UI。</p> <p>我们传入实现了MessageRepository接口的WelcomMessageRepository对象让Interactor使用。下面会讲到WelcomMessageRepository。</p> <p>为什么this也是Callback呢？因为MainActivity的MainPresenter实现了Callback接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainPresenterImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPresenter</span> <span class="token keyword">implements</span>
        <span class="token class-name">MainPresenter</span><span class="token punctuation">,</span><span class="token class-name">WelcomingInteractor<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{</span>
      
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们就是这么监听Interactor的事件的。下面是MainPresenter的代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  @Override
  public void onMessageRetrieved(String message) {
          mView.hideProgress();
          mView.displayWelcomeMessage(message);
          }
  @Override
  public void onRetrievalFailed(String error) {
          mView.hideProgress();
          onError(error);
          }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在代码段中我们看到的View其实就是实现了MainPresenter.View接口的MainActivity：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">MainPresenter<span class="token punctuation">.</span>View</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>View用于展示消息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  @Override
  public void displayWelcomeMessage(String msg) {
    mWelcomeTextView.setText(msg);
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Presentation层的东西就这么多了。</p> <p>####编写Storage层：</p> <p>repository中的接口就在storage层实现。所有与数据库相关的代码都在这里。资源库模式下数据的来源是不确定的，意思是逻辑代码不关心数据的来源，不论是数据库、服务器还是文件。</p> <p>你可以用ContentProvider或DBFlow等ORM工具处理更复杂的数据。如果你需要从网络获取数据那你可以用Retrofit。如果你只需要基本的键值对存储那你可以用SharedPreferences。不管怎样，一定要选对工具。</p> <p>这里我们的数据库不是真正的数据库，只是一个模拟了延迟的一个很简单的类。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WelcomeMessageRepository</span> <span class="token keyword">implements</span> <span class="token class-name">MessageRepository</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getWelcomeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;Welcome, friend!&quot;</span><span class="token punctuation">;</span> 
        <span class="token comment">// 模拟网络/数据库延迟</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>WelcomingInteractor可能以为延迟是网络或其他原因造成的，但它并不关心，它只需要数据提供者实现了MessageRepository接口。</p> <p>详细代码请看这个 git repo 。总结一下各个类的触发顺序：</p> <p>MainActivity -&gt;MainPresenter -&gt; WelcomingInteractor -&gt; WelcomeMessageRepository -&gt; WelcomingInteractor -&gt; MainPresenter -&gt; MainActivity</p> <p>控制流的顺序：Outer — Mid — Core — Outer — Core — Mid — Outer</p> <p>在一个use case中多次访问外层很正常。比如当你要显示、存储加访问网络，你的控制流会访问外层至少三次。</p></div> <footer class="page-edit" data-v-5a36e591><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/articles/android/A002.html">
          #Android图片高斯模糊和镜像翻转
        </a>
        →
      </span></p></div> </main> <span data-v-6890aafa></span></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ea900448.js" defer></script><script src="/assets/js/2.1721b7ec.js" defer></script><script src="/assets/js/3.161a97f9.js" defer></script><script src="/assets/js/24.e1a2b1ca.js" defer></script><script src="/assets/js/7.06ceafdc.js" defer></script>
  </body>
</html>
